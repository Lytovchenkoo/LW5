<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/styles.css" />
    <title>–ì—Ä—É–ø–∏ —Å—Ç—É–¥–µ–Ω—Ç—ñ–≤</title>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <form action="/admin/search" method="POST" class="group-search">
          <div class="group-search__input-wrapper">
            <input
              type="text"
              name="group"
              value="<%= selectedGroup || '' %>"
              required
              class="group-search__input"
              placeholder="–í–≤–µ–¥—ñ—Ç—å –¥–∞–Ω—ñ –¥–ª—è –ø–æ—à—É–∫—É"
            />
            <button
              type="submit"
              class="group-search__icon group-search__icon--search"
            >
              üîç
            </button>
          </div>
        </form>

        <div id="admin-controls"></div>

        <% if (students && students.length >= 0 && selectedGroup.includes('-')) { %>
        <button id="open-modal-student-btn" class="group-search__add-group">
          –î–æ–¥–∞—Ç–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞ –¥–æ –≥—Ä—É–ø–∏ <%= selectedGroup %>
          <span class="group-search__add-icon">‚ûï</span>
        </button>
        <% } %>
      </div>

      <% if (students && students.length > 0) { %>
      <div class="answear">
        <p>–†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –ø–æ—à—É–∫—É –¥–ª—è "<%= selectedGroup %>":</p>
      </div>

      <table class="student-table">
        <thead>
          <tr>
            <th>–ü–Ü–ë</th>
            <th>–†–µ–¥–∞–≥—É–≤–∞—Ç–∏</th>
            <th>–í–∏–¥–∞–ª–∏—Ç–∏</th>
          </tr>
        </thead>
        <tbody>
          <% students.forEach(student => { %>
          <tr>
            <td>
              <%= student.name %>
              <% if (student.group && student.group.name) { %> (–ì—Ä—É–ø–∞: <%= student.group.name %>)
              <% } else if (student.group) { %> (–ì—Ä—É–ø–∞: <%= student.group %>) <% } %>
            </td>
            <td>
              <button
                class="edit-btn"
                onclick="editStudent('<%= selectedGroup.includes('-') ? selectedGroup : (student.group.name || student.group) %>', '<%= student.name %>')"
              >
                ‚úèÔ∏è
              </button>
            </td>
            <td>
              <form action="/admin/delete" method="POST" class="delete-form">
                <input
                  type="hidden"
                  name="group"
                  value="<%= selectedGroup.includes('-') ? selectedGroup : (student.group.name || student.group) %>"
                />
                <input
                  type="hidden"
                  name="studentName"
                  value="<%= student.name %>"
                />
                <button type="submit" class="delete-btn">üóëÔ∏è</button>
              </form>
            </td>
          </tr>
          <% }) %>
        </tbody>
      </table>
      <% } %>

      <% if (typeof message !== 'undefined' && message) { %>
      <p class="answear"><%= message %></p>
      <% } %>

      <!-- –ú–æ–¥–∞–ª—å–Ω—ñ –≤—ñ–∫–Ω–∞ -->
      <div id="modal-add-group" class="modal hidden">
        <div class="modal__content">
          <h2 class="modal__title">–ù–æ–≤–∞ –≥—Ä—É–ø–∞</h2>
          <form
            id="add-group-form"
            action="/admin/add-group"
            method="POST"
            class="modal__form"
          >
            <input
              type="text"
              name="groupName"
              placeholder="–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –≥—Ä—É–ø–∏"
              required
              class="modal__input"
            />
            <div class="modal__actions">
              <button type="submit" class="modal__btn modal__btn--confirm">
                –î–æ–¥–∞—Ç–∏
              </button>
              <button
                type="button"
                id="close-modal-group-btn"
                class="modal__btn modal__btn--cancel"
              >
                –ó–∞–∫—Ä–∏—Ç–∏
              </button>
            </div>
          </form>
        </div>
      </div>

      <div id="modal-add-student" class="modal hidden">
        <div class="modal__content">
          <h2 class="modal__title">–ù–æ–≤–∏–π —Å—Ç—É–¥–µ–Ω—Ç</h2>
          <form action="/admin/add-student" method="POST" class="modal__form">
            <label for="newStudentName" class="modal__label">–Ü–º º—è:</label>
            <input
              type="text"
              id="newStudentName"
              name="studentName"
              required
              class="modal__input"
            />
            <input type="hidden" name="group" value="<%= selectedGroup %>" />
            <div class="modal__actions">
              <button type="submit" class="modal__btn modal__btn--confirm">
                ‚ûï –î–æ–¥–∞—Ç–∏
              </button>
              <button
                type="button"
                id="close-modal-student-btn"
                class="modal__btn modal__btn--cancel"
              >
                –°–∫–∞—Å—É–≤–∞—Ç–∏
              </button>
            </div>
          </form>
        </div>
      </div>

      <div id="modal-edit-student" class="modal hidden">
        <div class="modal__content">
          <h2 class="modal__title">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —Å—Ç—É–¥–µ–Ω—Ç–∞</h2>
          <form action="/admin/edit" method="POST" class="modal__form">
            <input type="hidden" name="group" id="editStudentGroup" />
            <input type="hidden" name="oldName" id="editOldName" />
            <label for="editOldName" class="modal__label">–ü–Ü–ë:</label>
            <input
              type="text"
              id="editStudentName"
              name="studentName"
              required
              class="modal__input"
            />
            <div class="modal__actions">
              <button type="submit" class="modal__btn modal__btn--confirm">
                üíæ –ó–±–µ—Ä–µ–≥—Ç–∏
              </button>
              <button
                type="button"
                id="close-edit-modal-btn"
                class="modal__btn modal__btn--cancel"
              >
                –°–∫–∞—Å—É–≤–∞—Ç–∏
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      const modalAddGroup = document.getElementById("modal-add-group");
      const modalAddStudent = document.getElementById("modal-add-student");
      const modalEditStudent = document.getElementById("modal-edit-student");

      const closeGroupBtn = document.getElementById("close-modal-group-btn");
      const closeStudentBtn = document.getElementById("close-modal-student-btn");
      const closeEditModalBtn = document.getElementById("close-edit-modal-btn");
      const studentBtn = document.getElementById("open-modal-student-btn");

      const adminControls = document.getElementById("admin-controls");

      if (window.location.pathname === "/admin") {
        const groupBtn = document.createElement("button");
        groupBtn.id = "open-modal-group-btn";
        groupBtn.className = "group-search__add-group";
        groupBtn.innerHTML =
          '–î–æ–¥–∞—Ç–∏ –Ω–æ–≤—É –≥—Ä—É–ø—É <span class="group-search__add-icon">‚ûï</span>';
        adminControls.appendChild(groupBtn);

        groupBtn.addEventListener("click", () => {
          modalAddGroup.classList.remove("hidden");
        });
      }

      if (closeGroupBtn)
        closeGroupBtn.addEventListener("click", () =>
          modalAddGroup.classList.add("hidden")
        );
      if (closeStudentBtn)
        closeStudentBtn.addEventListener("click", () =>
          modalAddStudent.classList.add("hidden")
        );
      if (closeEditModalBtn)
        closeEditModalBtn.addEventListener("click", () =>
          modalEditStudent.classList.add("hidden")
        );

      if (studentBtn) {
        studentBtn.addEventListener("click", () =>
          modalAddStudent.classList.remove("hidden")
        );
      }

      function editStudent(group, name) {
        document.getElementById("editStudentGroup").value = group;
        document.getElementById("editOldName").value = name;
        modalEditStudent.classList.remove("hidden");
      }

      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get("newGroup") === "true") {
        const groupFromURL = urlParams.get("selectedGroup");
        modalAddStudent.classList.remove("hidden");

        const groupInput = document.querySelector(
          '#modal-add-student input[name="group"]'
        );
        if (groupInput && groupFromURL) {
          groupInput.value = groupFromURL;
        }
      }
    </script>
  </body>
</html>
